name: CI
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  CI:
    defaults:
      run:
        shell: bash
    strategy:
      matrix:
        cxx: ['g++']
        cmake_build_type: ['Debug', 'Release']
       
    runs-on: ubuntu-20.04
    container:
      image: docker.io/openfoam/openfoam10-paraview510
      options: --user root
    steps:
      - name: Checkout AdditiveFOAM
        uses: actions/checkout@v2
      - name: Build AdditiveFOAM
        env:
          USER_DIR: ${WM_PROJECT_USER_DIR}
        run: |
          cd $USER_DIR/AdditiveFOAM/applications/solvers/additiveFoam/movingHeatSource
          wmake libso
          cd $USER_DIR/AdditiveFOAM/applications/solvers/additiveFoam
          wmake
      - name: Test AdditiveFOAM
        working-directory: examples
        env:
          USER_DIR: ${WM_PROJECT_USER_DIR}
          RUN_DIR: ${FOAM_RUN}
        run: |
          mkdir -p $RUN_DIR/additivefoam
          cd $RUN_DIR/additivefoam
          cp -r $WM_PROJECT_USER_DIR/AdditiveFOAM/tutorials/AMB2018-02-B userCase
          cd userCase
          # FIXME: use built-in "additiveFoam" smaller case when created
          blockMesh
          decomposePar
          mpirun -n 6 --oversubscribe additiveFoam -parallel > log.additiveFoam
